/*--------------------------------------------------------------------------#
#  Jenkins running on remote EC2 AWS instance, remote webserver too         #
#  Need to install ssh plugins                                              #
#  Edit jenkins configuration to add remote server and ssh key              #
#  Its better to set "/" directory and define declaratively                 #
#  Create new pipeline, choose SCM using https                              #
#                                                                           #
#  Select "Script path" in git repo /jenkins/docker_php_deploy/Jenkinsfile  #
#                                                                           #
#  Update date:        31.05.2023                                           #
#--------------------------------------------------------------------------*/
pipeline {
    agent { label 'slave-1' }
    environment {
        CI_IMAGE_NAME = 'web_container'
        CI_CONTAINER_NAME = 'test_container'
        CONTAINER_EXTERNAL_PORT = '8080'
        CD_IMAGE_REPO_USER = 'wood8'
        CD_IMAGE_NAME_VERSION = 'jenkins-cicd'
    }

    options {
        skipDefaultCheckout()
        timestamps()
    }

    stages {
        stage('Checkout') {
            steps {
                git(
                    url: 'https://github.com/gitwood8/jenkins-deploy-webpage.git',
                    branch: 'main'
                )
            }
        }

//        stage('Transfer files') {
//            steps {
//                echo '------Starting transfer files over SSH------'
//                sshPublisher(
//                    publishers: [
//                        sshPublisherDesc(
//                            configName: 'slave-1',
//                            transfers: [
//                                sshTransfer(
//                                    //the same directory structure as in the source directory during the file transfer
//                                    //    flatten: false,
//                                    remoteDirectory: '/home/ec2-user/qwe/',
//                                    sourceFiles: 'jenkins/docker_php_deploy/*',
//                                    excludes: 'jenkins/docker_php_deploy/git-scr',
//                                    removePrefix: 'jenkins/docker_php_deploy/'
//                                    )
//                                ]
//                            )
//                        ]
//                    )
//                echo '------Finished transfer files over SSH------'
//            }
//        }
//
//        stage('Run container') {
//            steps {
//                echo '------Run container------'
//                sshPublisher(
//                    publishers: [
//                        sshPublisherDesc(
//                            configName: 'slave-1',
//                            transfers: [
//                                sshTransfer(
//                                    remoteDirectory: '/home/ec2-user/qwe/',
//                                    execCommand: '''
//                                        docker build -t ${env.CI_IMAGE_NAME} /home/ec2-user/qwe/;
//                                        docker run -d --name ${env.CI_CONTAINER_NAME} \
//                                        -p ${env.CONTAINER_EXTERNAL_PORT}:80 ${env.CI_IMAGE_NAME};
//                                        sleep 20
//                                    '''
//                                ),
//                                sshTransfer(
//                                    remoteDirectory: '/home/ec2-user/qwe/',
//                                    execCommand: '''
//                                        docker inspect --format='{{json .State.Health}}' \
//                                        $(docker ps -q) | grep "Status":"healthy"
//                                    '''
//                                )
//                            ]
//                        )
//                    ]
//                )
//                // This commands executes on jenkins host
//                //                sh 'cat /etc/os-release'
//                echo '------Container work done------'
//            }
//        }
    }
}
