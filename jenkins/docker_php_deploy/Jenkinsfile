/*--------------------------------------------------------------------------#
#  Jenkins running on remote EC2 AWS instance, remote webserver too         #
#  Need to install ssh plugins                                              #
#  Edit jenkins configuration to add remote server and ssh key              #
#  Its better to set "/" directory and define declaratively                 #
#  Create new pipeline, choose SCM using https                              #
#                                                                           #
#  Select "Script path" in git repo /jenkins/docker_php_deploy/Jenkinsfile  #
#                                                                           #
#  Update date:        31.05.2023                                           #
#--------------------------------------------------------------------------*/
pipeline {
    agent any
    environment {
        CI_IMAGE_NAME = 'web_container'
        CI_CONTAINER_NAME = 'test_container'
        CONTAINER_EXTERNAL_PORT = '8080'
        CD_IMAGE_REPO_USER = 'wood8'
        CD_IMAGE_NAME_VERSION = 'jenkins-cicd'
    }

    options {
        skipDefaultCheckout()
        timestamps()
    }

    stages {
        stage('Checkout') {
            steps {
                git(
                    url: 'https://github.com/gitwood8/jenkins-deploy-webpage.git',
                    branch: 'main'
                )
            }
        }

        stage('Transfer files') {
            steps {
                echo '------Starting publish over SSH------'
                sshPublisher(
                    publishers: [
                        sshPublisherDesc(
                            configName: 'awsaws',
                            transfers: [
                                sshTransfer(
                                    //the same directory structure as in the source directory during the file transfer
                                    flatten: false,
                                    remoteDirectory: '~/qwe/',
                                    sourceFiles: '*'
                                    )
                                ]
                            )
                        ]
                    )
                echo '------Finished publish over SSH------'
            }
        }

//        stage('Build') {
//            steps {
//                script {
//                    sh '''
//                        docker build -t ${CI_IMAGE_NAME} .
//                        docker run -d --name ${CI_CONTAINER_NAME} -p ${CONTAINER_EXTERNAL_PORT}:80 ${CI_IMAGE_NAME}
//                        sleep 15
//                        docker inspect --format='{{json .State.Health}}' $(docker ps -q) | grep \"Status\":\"healthy\"
//                    '''
//                }
//            }
//        }

        stage('Run container') {
            steps {
                echo '------Run container------'
                sshPublisher(
                    //continueOnError: true,
                    //failOnError: true,
                    publishers: [
                        sshPublisherDesc(
                            configName: 'awsaws',
                            transfers: [
                                sshTransfer(
                                    execCommand:
                                    '
                                    docker build -t ${CI_IMAGE_NAME} .;
                                    docker run -d --name ${CI_CONTAINER_NAME} -p ${CONTAINER_EXTERNAL_PORT}:80 ${CI_IMAGE_NAME};
                                    sleep 15;
                                    docker inspect --format='{{json .State.Health}}' $(docker ps -q) | grep \"Status\":\"healthy\"
                                    '
                                )
                            ]
                        )
                    ]
                )
                echo '------Webserver restarted------'
            }
        }
    }
}
